<!doctype html>
<html class='no-js' lang=''>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Git Quest</title>
    <script src='//localhost:35729/livereload.js'></script>
    <script src='https://code.createjs.com/createjs-2015.11.26.min.js'></script>
</head>

<body>
    <canvas id='canvas' width='900' height='400' style='background-color: #eee'></canvas>
    <script>
        var ENTER = 13,
            SPACE = 32,
            KEY_LEFT = 37,
            KEY_UP = 38,
            KEY_RIGHT = 39,
            KEY_DOWN = 40

        var speed = 3
        var width = 32
        var height = 32

        var base = 'https://api.github.com/repos/'

        var getUrl = function(user, repo, path) {
            return base + user + '/' + repo + '/contents/' + path
        }

        function handleFileLoad(event) {
            console.log(event.result)
            init(event.result)
        }

        function handleComplete(event) {}

        function loadMap(user, repo, path) {
            var queue = new createjs.LoadQueue()
            queue.on('fileload', handleFileLoad, this)
            queue.on('complete', handleComplete, this)
            queue.loadFile({
                src: getUrl(user, repo, path),
                type: createjs.AbstractLoader.JSON
            })

            queue.load()
        }

        loadMap('pnagi', 'Lecture', '')

        function initMap(repo) {
            var map = new createjs.Container()
            var tileset = new createjs.SpriteSheet({
                images: ['img/pokemon_bw2___season_tiles_by_shiney570-d9cytb8.png'],
                frames: {
                    width: 32,
                    height: 32
                },
                animations: {
                    item: 65
                }
            })

            var count = 0;
            for (var row = 0; row < canvas.height / 32; row++) {
                for (var col = 0; col < canvas.width / 32; col++) {
                    var tile = new createjs.Sprite(tileset);

                    switch (row % 4) {
                        case 0:
                            tile.gotoAndStop(count++ % 4 + 4);
                            break
                        case 1:
                            tile.gotoAndStop(count++ % 4 + 4 + 16);
                            break
                        case 2:
                            tile.gotoAndStop(count++ % 4 + 4 + 32);
                            break
                        case 3:
                            tile.gotoAndStop(count++ % 4 + 4 + 48);
                            break
                    }

                    tile.x = 32 * col;
                    tile.y = 32 * row;
                    map.addChild(tile);
                }
                count = 0;
            }

            var size = 32
            var count = [1, 1]

            repo.forEach(function(data) {

                var item = new createjs.Sprite(tileset, "item").set({
                    x: -size + size * 2 * count[0]++,
                    y: -size + size * 2 * count[1]
                });

                if (size + size * 2 * count[0]> canvas.width) {
                    count[0] = 1
                    count[1]++
                }
                if (size + size * 2 * count[1]> canvas.height) {
                    count[0] = 1
                }

                map.addChild(item)
            })

            return map
        }

        function initPlayer() {
            var playerData = {
                images: ['img/event2.png'],
                frames: {
                    width: 32,
                    height: 48,
                    regX: 0,
                    regY: 0,
                    spacing: 0,
                    margin: 0
                },
                animations: {
                    left: 4,
                    up: 12,
                    right: 8,
                    down: 0,
                    walkleft: {
                        frames: [5, 6, 7, 6],
                        speed: 0.15
                    },
                    walkup: {
                        frames: [13, 14, 15, 14],
                        speed: 0.15
                    },
                    walkright: {
                        frames: [9, 10, 11, 10],
                        speed: 0.15
                    },
                    walkdown: {
                        frames: [1, 2, 3, 2],
                        speed: 0.15
                    },
                    run: [1, 5],
                    jump: [6, 8, 'run']
                }
            }

            var playerData2 = {
                images: ['img/tileset-hoenn_ows_remake.png'],
                frames: {
                    width: 32,
                    height: 32,
                    regX: 0,
                    regY: 0,
                    spacing: 0,
                    margin: 0
                },
                animations: {
                    left: 28,
                    up: 27,
                    right: 3,
                    down: 2,
                    walkleft: {
                        frames: [28],
                        speed: 0.15
                    },
                    walkup: {
                        frames: [27],
                        speed: 0.15
                    },
                    walkright: {
                        frames: [3],
                        speed: 0.15
                    },
                    walkdown: {
                        frames: [2],
                        speed: 0.15
                    },
                    run: [1, 5],
                    jump: [6, 8, 'run']
                }
            }

            var spriteSheet = new createjs.SpriteSheet(playerData2)
            var player = new createjs.Sprite(spriteSheet, "down")

            player.x = (canvas.width - width) / 2
            player.y = (canvas.height - height) / 2

            return player
        }

        function init(repo) {
            var canvas = document.getElementById('canvas')

            canvas.width = window.innerWidth - 16;
            // canvas.height = window.innerHeight - 16;

            var stage = new createjs.Stage(canvas)

            var player = initPlayer()
            var map = initMap(repo)

            var d = [0, 0, 0, 0]

            function talk() {
                console.log('talk')
                loadMap('pnagi', 'Lecture', 'Algorithm')
            }

            var getAction = function(e) {
                console.log(e.keyCode)
                switch (e.keyCode) {
                    case ENTER:
                        talk()
                        break
                    case SPACE:
                        talk()
                        break
                    case KEY_LEFT:
                        if (player.currentAnimation != 'walkleft')
                            player.gotoAndPlay('walkleft')
                        break
                    case KEY_UP:
                        if (player.currentAnimation != 'walkup')
                            player.gotoAndPlay('walkup')
                        break
                    case KEY_RIGHT:
                        if (player.currentAnimation != 'walkright')
                            player.gotoAndPlay('walkright')
                        break
                    case KEY_DOWN:
                        if (player.currentAnimation != 'walkdown')
                            player.gotoAndPlay('walkdown')
                        break
                }
            }

            var stopWalkAnimation = function(e) {
                switch (e.keyCode) {
                    case KEY_LEFT:
                        if (player.currentAnimation == 'walkleft')
                            player.gotoAndStop('left')
                        break
                    case KEY_UP:
                        if (player.currentAnimation == 'walkup')
                            player.gotoAndStop('up')
                        break
                    case KEY_RIGHT:
                        if (player.currentAnimation == 'walkright')
                            player.gotoAndStop('right')
                        break
                    case KEY_DOWN:
                        if (player.currentAnimation == 'walkdown')
                            player.gotoAndStop('down')
                        break
                }
            }

            var _setD = function(e, d1, d2) {
                if (!e) {
                    e = window.event
                }
                switch (e.keyCode) {
                    case KEY_LEFT:
                        return d[0] = d1
                    case KEY_UP:
                        return d[1] = d1
                    case KEY_RIGHT:
                        return d[2] = d2
                    case KEY_DOWN:
                        return d[3] = d2
                }
            }

            document.onkeydown = function(e) {
                getAction(e)
                return _setD(e, -1 * speed, speed)
            }

            document.onkeyup = function(e) {
                stopWalkAnimation(e)
                return _setD(e, 0, 0)
            }

            var wall = {
                left: 0,
                top: canvas.height - height,
                right: canvas.width - width,
                bottom: 0
            }

            window.tick = function() {
                player.x += d[0] + d[2]
                if (player.x < wall.left) {
                    player.x = wall.left
                }
                if (player.x > wall.right) {
                    player.x = wall.right
                }

                player.y += d[1] + d[3]
                if (player.y < wall.bottom) {
                    player.y = wall.bottom
                }
                if (player.y > wall.top) {
                    player.y = wall.top
                }

                return stage.update()
            }

            createjs.Ticker.addEventListener('tick', window.tick)
            createjs.Ticker.useRAF = true
            createjs.Ticker.setFPS(60)

            stage.addChild(map)
            stage.addChild(player)
            stage.update()
        }
    </script>
</body>

</html>
